---
language: python
python: "2.7"

before_install:
# Make sure everything's up to date.
- sudo apt-get update -qq

install:
# Install Ansible.
- pip install ansible

# Add ansible.cfg to pick up roles path.
- "printf '[defaults]\nroles_path = ../' > ansible.cfg"

script:
# Create foobar user to ensure deletion works
- ansible -i inventory localhost -m user -a "name=foobar" --sudo
# Check the role/playbook's syntax.
- ansible-playbook -i tests/inventory tests/test.yml --syntax-check
# Run the role/playbook with ansible-playbook.
- "ansible-playbook -i tests/inventory tests/test.yml"
# Run the role/playbook again, checking to make sure it's idempotent.
- >
  ansible-playbook -i tests/inventory tests/test.yml
  | grep -q 'changed=0.*failed=0'
  && (echo 'Idempotence test: pass' && exit 0)
  || (echo 'Idempotence test: fail' && exit 1)
# ensure foo user exists
getent passwd foo > /dev/null
# ensure foo user has the correct groups
sudo groups foo | grep sudo
sudo groups foo | grep adm
sudo groups foo | grep dialout
sudo groups foo | grep cdrom
sudo groups foo | grep floppy
sudo groups foo | grep audio
sudo groups foo | grep video
sudo groups foo | grep plugdev
sudo groups foo | grep netdev
# ensure foobar user was deleted
- >
  - ansible -i inventory localhost -m user -a "name=foobar state=absent" --sudo
  | grep -q '"changed": false'
  && (echo 'Idempotence test: pass' && exit 0)
  || (echo 'Idempotence test: fail' && exit 1)
